!function(a){function b(b){Handsontable.plugins.BasePlugin.call(this,b),this._superClass=Handsontable.plugins.BasePlugin,this.originals={},this.originals.getCopyableData=b.getCopyableData,this.table_id=b.rootElement.id,this.tableDrawRequests=0,this.tableDrawResponses=0,this.tableSettings={},this.$SEARCH_FIELD=a("#"+this.table_id+"_search_filter input"),this.loadLanguages()}b.prototype=Object.create(Handsontable.plugins.BasePlugin.prototype,{constructor:{writable:!0,configurable:!0,value:b}}),b.prototype.isEnabled=function(){return!!this.hot.getSettings().wpDataTablesExcelPlugin},b.prototype.enablePlugin=function(){this.overrideHotFunctions();for(var b in this.languages)numeral.language(b,this.languages[b]);var c={},d=a(this.hot.rootElement).data("described-by");d&&($descriptionElement=a("#"+d))&&(c=a.parseJSON($descriptionElement.val()),this.tableSettings=c.dataTableParams,delete c.dataTableParams);for(var e in c)this[e]=c[e];this.tableSettings.language="en-"+this.tableSettings.number_format;for(var f=0;f<this.tableSettings.columns.length;f++)"wdt.date"==this.tableSettings.columns[f].type&&(this.tableSettings.columns[f].sortFunction=this.sortDate),this.serverSide&&this.setCellValidator(this.tableSettings.columns[f]);this.serverSide?(this.tableSettings.minSpareRows=1,this.addContextMenuItems(),Handsontable.Search.global.setDefaultCallback(this.wdtExcelSearchCallback),this.addHook("afterChange",this.onAfterChange.bind(this)),this.addHook("init",this.onInit.bind(this)),this.addHook("afterValidate",this.onAfterValidate.bind(this))):(this.tableSettings.data=a.parseJSON(a(c.selector+"_data").val()),this.addHook("init",this.onInit.bind(this))),this.addHook("beforeAutofill",this.onBeforeAutofill),this.addHook("beforeValidate",this.onBeforeValidate),this.addHook("beforeChange",this.onBeforeChange),"object"==typeof wpDtExcelTables[this.table_id]&&a.extend(!0,this.tableSettings,wpDtExcelTables[this.table_id]),this._superClass.prototype.enablePlugin.call(this)},b.prototype.overrideHotFunctions=function(){var a=this.originals.getCopyableData;this.hot.getCopyableData=function(b,c){var d=this.getCellMeta(b,c),e=a.apply(this,arguments);return"numeric"==d.type?e=numeral(e).format(d.format):"wdt.date"==d.type&&(e=moment(e,d.dataSourceDateFormat).format(d.displayDateFormat)),e}},b.prototype.revertOverriddenHotFunctions=function(){this.hot.getCopyableData=this.originals.getCopyableData},b.prototype.initTableSettings=function(){this.hot.updateSettings(this.tableSettings)},b.prototype.disablePlugin=function(){this.revertOverriddenHotFunctions(),this.tableDrawRequests=0,this.tableDrawResponses=0,this.tableSettings={},this.removeEvents(),this.removeHook("beforeAutofill",this.onBeforeAutofill),this.removeHook("beforeValidate",this.onBeforeValidate),this.removeHook("beforeChange",this.onBeforeChange),this._superClass.prototype.disablePlugin.call(this)},b.prototype.updatePlugin=function(){this._superClass.prototype.updatePlugin.call(this)},b.prototype.destroy=function(){this._superClass.prototype.destroy.call(this)},b.prototype.initEvents=function(){var b=this.hot.rootElement;this.serverSide&&(a(b).on("click.wpExcelTable","a.wdt_link_editable",function(b){b.preventDefault(),b.ctrlKey&&window.open(a(this).attr("href"),a(this).attr("target"))}),a(b).on("click.wpExcelTable","a.wdt_email_editable",function(b){b.preventDefault(),b.ctrlKey&&(location.href=a(this).attr("href"))}))},b.prototype.initSearch=function(){var a=this.hot,b=a.getSettings();b.search&&(this.$SEARCH_FIELD.on("keyup.wpExcelTable search.wpExcelTable",function(b){a.search.query(this.value),a.render()}),b.searchDefaultValue&&this.$SEARCH_FIELD.val(b.searchDefaultValue))},b.prototype.removeEvents=function(){var b=this.hot.rootElement;a(b).off("click.wpExcelTable",".wpExcelTable a.wdt_link_editable"),a(b).off("click.wpExcelTable",".wpExcelTable a.wdt_email_editable"),this.$SEARCH_FIELD.off("keyup.wpExcelTable search.wpExcelTable")},b.prototype.getCellValidatorByName=function(a){var b=a.replace(/(?:(wdt)\.)?(.+)/,function(a,b,c){return c?(b=b||"",b+c.charAt(0).toUpperCase()+c.slice(1)+"Validator"):null});return b&&Handsontable[b]?Handsontable[b]:null},b.prototype.setCellValidator=function(a){var b=a.validator;if(b){var c=this.getCellValidatorByName(b);c&&("dropdown"==a.type||"wdt.multi-select"==a.type?(a.cell_validator=c,delete a.validator):a.validator=c)}},b.prototype.getRemoteTableData=function(){var b=this,c=this.hot,d=c.getSettings();if(d.serverSide){for(var e=d.ajax,f=d.columns,g=d.columnSorting,h=Boolean(g),i=[],j=0;j<f.length;j++){var k={data:j,name:f[j].data,searchable:f[j].search,orderable:h};i.push(k)}var l={draw:b.tableDrawRequests+1,table:"excel",columns:i,start:0,length:-1};if(h){var m=[],n=g.column,o=g.sortOrder?"asc":"desc",p={column:n,dir:o};m.push(p),l.order=m}var q={data:l,dataType:"json",success:function(a){a.draw&&a.draw>b.tableDrawResponses&&(b.tableDrawResponses=a.draw,c.loadData(a.data))},error:function(a){console.log(a)},beforeSend:function(a,c){b.tableDrawRequests++,b.toggleTableOverlay("show")},complete:function(){b.toggleTableOverlay("hide")}};a.extend(e,q),a.ajax(e)}},b.prototype.loadLanguages=function(){var b={};b.en={delimiters:{thousands:",",decimal:"."},abbreviations:{thousand:"k",million:"m",billion:"b",trillion:"t"},ordinal:function(a){var b=a%10;return 1===~~(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th"},currency:{symbol:"$"}},b["en-1"]=a.extend(!0,{},b.en),b["en-1"].delimiters.thousands=".",b["en-1"].delimiters.decimal=",",b["en-2"]=a.extend(!0,{},b.en),this.languages=b},b.prototype.queryDateCell=function(a,b,c,d){var e=a.getSettings(),f=this.$SEARCH_FIELD.val(),g=moment(d,e.dataSourceDateFormat).format(e.displayDateFormat);return Handsontable.Search.DEFAULT_QUERY_METHOD(f,g)},b.prototype.wdtExcelSearchCallback=function(a,b,c,d,e){var f=a.getCellMeta(b,c);"wdt.date"!=f.renderer||e?Handsontable.Search.DEFAULT_CALLBACK.apply(this,arguments):f.isSearchResult=a.getPlugin("WpDataTablesExcelPlugin").queryDateCell(a,b,c,d)},b.prototype.prepareDataToSaveRemote=function(b){for(var h,i,j,k,c=this.hot.getSettings(),d=c.idColumnKey,e=[],f=[],g=[],l=0;l<b.length;l++){if(h=b[l][0],i=b[l][1],j=b[l][2],k=b[l][3],j!=k)if("undefined"==typeof e[h]){var m=this.hot.getDataAtRowProp(h,d),n={};n[d]=m,n[i]=k,e[h]=n}else e[h][i]=k;if(a.inArray(h,f)==-1){var o=this.hot.getSourceDataAtRow(h);g.push(o),f.push(h)}}if(e.length>0){var p=[];for(var q in e)p.push(e[q]);e=p}return{cells:e,rows:g}};var c=function(a){a.stopImmediatePropagation(),a.preventDefault()};b.prototype.toggleTableOverlay=function(b){var d=this.hot;"show"==b?(a(d.rootElement).find("table.htCore").addClass("overlayed_elm"),d.addHook("beforeKeyDown",c)):"hide"==b&&(a(d.rootElement).find("table.htCore").removeClass("overlayed_elm"),d.removeHook("beforeKeyDown",c))},b.prototype.saveChangesRemote=function(b){var c=this.hot.getSettings(),d=this.tableWpId,e=this.prepareDataToSaveRemote(b),f=e.cells,g=e.rows,h=this;if(f.length>0){var i={action:"wdt_save_table_cells_frontend",wdtNonce:a("#wdtNonceFronendEdit").val(),table_id:d,cells:f,rows:g};a.ajax({url:c.adminAjaxBaseUrl,type:"POST",dataType:"json",data:i,success:function(a){h.toggleTableOverlay("hide"),(a.error.length>0||a.has_new)&&h.getRemoteTableData(),a.error.length>0?alert(a.error):a.formula_cells&&h.applyCellsData(a.formula_cells,"updateFormulaValues")},error:function(a){h.toggleTableOverlay("hide"),alert(a.error),h.getRemoteTableData()},beforeSend:function(){h.toggleTableOverlay("show")}})}},b.prototype.applyCellsData=function(a,b){if(0!=a.length){for(var c=[],d=this.hot,e=d.getSettings().idColumnKey,f=d.countRows(),g=0;g<f;g++)for(var h=d.getDataAtRowProp(g,e),i=0;i<a.length;i++){var j=a[i];if(j[e]==h)for(var k in j)k!=e&&c.push([g,k,j[k]])}c.length>0&&d.setDataAtRowProp(c,b)}},b.prototype.onAfterChange=function(a,b){"loadData"!==b&&"updateFormulaValues"!==b&&this.saveChangesRemote(a);var c=this.hot;c.getSettings().search&&(c.search.query(this.$SEARCH_FIELD.val()),c.render())},b.prototype.onInit=function(){this.initTableSettings(),this.initEvents(),this.initSearch(),this.getRemoteTableData()},b.prototype.onAfterValidate=function(b,c,d,e,f){var g=a(document.activeElement),h=void 0;g.is(":input")&&(h=g.closest("#"+this.hot.rootElement.id+" > div")),h&&(h.tooltip("instance")||(h.attr("title",""),h.tooltip({content:wpdatatables_frontend_strings.invalid_value,show:!1,position:{my:"left bottom",at:"left-10 top-5"}})),b?(h.removeClass("invalid_editor_value"),h.tooltip("destroy")):(h.addClass("invalid_editor_value"),h.tooltip("open")))},b.prototype.onBeforeAutofill=function(a,b,c){for(var d=0;d<c.length;d++)for(var e=0;e<c[d].length;e++){var f=this.getCellMeta(a.row+d,a.col+e);"numeric"==f.type&&numeral.validate(c[d][e])&&(c[d][e]=numeral(c[d][e]).format(f.format))}},b.prototype.onBeforeValidate=function(a,b,c,e){return d.apply(this,arguments)};var d=function(a,b,c,d){var e=this.propToCol(c),f=this.getDataType(b,e,b,e);if("wdt.date"==f){if(!a)return"";if("paste"!=d){var g=this.getSettings();a=moment(a,g.dataSourceDateFormat).format(g.displayDateFormat)}return a}};b.prototype.onBeforeChange=function(a,b){for(var c=0;c<a.length;c++){var d=this.propToCol(a[c][1]),e=this.getCellMeta(a[c][0],d);"wdt.date"==e.type&&"paste"==b&&(a[c][3]=moment(a[c][3],e.displayDateFormat).format(e.dataSourceDateFormat))}},b.prototype.addNewTableRow=function(a,b){var c=b.end.col,d=this.countEmptyRows(!0),e=this.countRows();if(d>0){var f=e-1;this.selectCell(f,c,f,c)}else{var g=this.countEmptyRows(!1);if(g>0){for(var h=0;h<e;h++)if(this.isEmptyRow(h))return void this.selectCell(h,c,h,c)}else this.alter("insert_row")}},b.prototype.deleteTableRows=function(b,c){for(var d=c.start.row,e=c.end.row,f=this.getSettings(),g=f.idColumnKey,h=this.propToCol(g),i=this.getData(d,h,e,h),j=[],k=0;k<i.length;k++){var l=i[k][0];l&&j.push(i[k][0])}if(j.length>0){var m=this.getPlugin("wpDataTablesExcelPlugin"),n=m.tableWpId,o={};o[g]=j;var p={action:"wdt_delete_table_rows",table_id:n,rows:o,wdtNonce:a("#wdtNonceFronendEdit").val()};a.ajax({type:"POST",url:f.adminAjaxBaseUrl,data:p,dataType:"json",success:function(a){if(m.toggleTableOverlay("hide"),a.error.length>0)m.getRemoteTableData();else if(a.success.length>0)for(var b=d;b<=e;b++)this.alter("remove_row",b);else m.getRemoteTableData()},error:function(a){m.toggleTableOverlay("hide"),console.log(a),m.getRemoteTableData()},beforeSend:function(){m.toggleTableOverlay("show")}})}},b.prototype.addContextMenuItems=function(){this.contextMenu={items:{add_row:{name:"New row",callback:this.addNewTableRow},remove_row:{name:"Delete row(s)",callback:this.deleteTableRows,disabled:function(){var a=this.getSelected();return a[0]==a[2]&&this.isEmptyRow(a[0])}}}},this.tableSettings.contextMenu=this.contextMenu},b.prototype.sortDate=function(a){var b=a?1:-1;return function(a,c){var f,d=moment(a[1],"YYYY-MM-DD"),e=moment(c[1],"YYYY-MM-DD");return f=d.isValid()||e.isValid()?d.isValid()?e.isValid()?d.valueOf()-e.valueOf():1:-1:0,b*f}},b.prototype.removeContextMenuItems=function(){},Handsontable.plugins.registerPlugin("wpDataTablesExcelPlugin",b)}(jQuery);